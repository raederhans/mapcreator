# Hierarchy / Grouping Feasibility Plan (009)

Date: 2026-01-28

## 1) Data Audit Results (Can we group today?)

### China (geoBoundaries ADM2) — `data/china_adm2.geojson`
- **Columns present:** `shapeGroup`, `shapeID`, `shapeISO`, `shapeName`, `shapeType`.
- **No ADM1/Province fields.** There is no province name, ADM1 code, or parent identifier.
- **`shapeID` looks like a hash**, not an administrative code: hex-only, length 20–23, and all IDs share the same prefix (`17`). This does **not** encode the province.
- **Conclusion:** Not directly groupable by province from the current attributes. **Requires external linkage** (e.g., spatial join with an ADM1/province layer or a crosswalk keyed by county name + province).

### France (Arrondissements) — `data/france_arrondissements.geojson`
- **Columns present:** `code`, `nom`.
- **Grouping signals:**
  - `code` is 5 characters, mostly numeric; Corsica uses **`2A` / `2B`** prefixes (non-digit codes).
  - Department code is derivable from `code`:
    - **Metropolitan:** first 2 digits (e.g., `01001` → `01`).
    - **Corsica:** first 2 chars (`2A`, `2B`).
    - **Overseas:** first 3 digits when `code` starts with `97` or `98` (e.g., `97101` → `971`).
- **No region field** present, so Region requires a **department → region** mapping or a join to a department dataset.
- **Conclusion:** Can group by **department** immediately. Region requires external mapping.

### Poland (Powiaty) — `data/poland_powiaty.geojson`
- **Columns present:** `name`, `terc`.
- **Grouping signals:**
  - `terc` is **4 digits** everywhere.
  - **Voivodeship code = first 2 digits** of `terc` (16 unique prefixes).
- **Conclusion:** Grouping by **voivodeship** is directly feasible via `terc` prefix. Add a voivodeship code → name map for labels.

## 2) Storage Strategy

### Option A: Bake parent IDs into existing topology
- **Approach:** Add `parent_id`, `parent_name`, or `adm1_code` to each ADM2/arrondissement/powiat feature in `europe_topology.json` (and any country-specific topology).
- **Pros:**
  - Simple access in UI (single file).
  - No extra fetch at runtime.
- **Cons:**
  - **File size growth** (repeating parent data across many features).
  - Harder to update or swap parent mappings independently.
  - Mixes UI/grouping metadata into geometry assets.

### Option B (Recommended): Separate `data/hierarchy.json` lookup
- **Approach:** Generate a lightweight mapping file with parent → child IDs.
  - Example structure:
    ```json
    {
      "CN": {"ADM1": {"CN-51": {"name": "Sichuan", "children": ["CN_ADM2_...", "CN_ADM2_..."]}}},
      "FR": {"DEPT": {"01": {"name": "Ain", "children": ["01001", "01002"]}}},
      "PL": {"VOIV": {"02": {"name": "Dolnoslaskie", "children": ["0201", "0202"]}}}
    }
    ```
- **Pros:**
  - **Smaller geometry files**, faster initial load.
  - Easier to patch/update groupings without regenerating topology.
  - Supports multiple grouping layers (dept + region) in a clean way.
- **Cons:**
  - Requires an extra fetch and join step at runtime.
  - UI must handle missing mappings gracefully.

**Recommendation:** Option B. It keeps geometry assets stable and allows rapid iteration on grouping logic (especially for China, where a join is required).

## 3) UI Implementation Concept

- **Hierarchy-aware sidebar:** A tree view that lists available grouping levels per country (e.g., China: Province → County; France: Region → Department → Arrondissement; Poland: Voivodeship → Powiat).
- **Select Parent mode:** Clicking a parent highlights all child units; a toggle collapses children into a parent “bucket” for analysis/filters.
- **Lazy join:** On map load, fetch `hierarchy.json`, build in-memory maps `child → parent` and `parent → children`. If mapping missing, fall back to flat list.
- **Labeling:** Parent labels pulled from the hierarchy file (not from geometry), enabling consistent naming regardless of source.

## Next Steps (after approval)
- **China:** acquire ADM1 (province) boundaries and spatially join counties to provinces, or obtain a county → province crosswalk.
- **France:** add department → region mapping table (static) and derive department from `code`.
- **Poland:** add a voivodeship code → name mapping and derive via `terc` prefix.

---

Generated by: `tools/inspect_hierarchy_fields.py`
